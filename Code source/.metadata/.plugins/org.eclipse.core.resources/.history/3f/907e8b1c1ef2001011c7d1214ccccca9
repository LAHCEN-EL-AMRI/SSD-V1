import javax.swing.JFrame;
import java.awt.Color;
import java.awt.BasicStroke;
import java.awt.Font;
import java.awt.RenderingHints;

import org.jfree.chart.ChartFactory;
import org.jfree.chart.ChartPanel;
import org.jfree.chart.JFreeChart;
import org.jfree.chart.plot.PlotOrientation;
import org.jfree.chart.plot.XYPlot;
import org.jfree.chart.renderer.xy.XYLineAndShapeRenderer;
import org.jfree.chart.annotations.XYTextAnnotation;
import org.jfree.chart.axis.NumberAxis;
import org.jfree.data.xy.XYSeries;
import org.jfree.data.xy.XYSeriesCollection;

public class Chi_square_graph extends JFrame {

    private static final long serialVersionUID = 1L;

    public Chi_square_graph() {
        setTitle("Chi-Square Critical Values");
        setSize(1000, 650);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);

        // Tableau des valeurs critiques χ²
        double[][] chiValues = {
            {0.000, 0.000, 0.004, 0.016, 2.706, 3.841, 5.024, 6.635, 7.879},
            {0.010, 0.051, 0.103, 0.211, 4.605, 5.991, 7.378, 9.210, 10.597},
            {0.072, 0.216, 0.352, 0.584, 6.251, 7.815, 9.348, 11.345, 12.838},
            {0.207, 0.484, 0.711, 1.064, 7.779, 9.488, 11.143, 13.277, 14.860},
            {0.412, 0.831, 1.145, 1.610, 9.236, 11.070, 12.833, 15.086, 16.750},
            {0.676, 1.237, 1.635, 2.204, 10.645, 12.592, 14.449, 16.812, 18.548},
            {0.989, 1.690, 2.167, 2.833, 12.017, 14.067, 16.013, 18.475, 20.278},
            {1.344, 2.180, 2.733, 3.490, 13.362, 15.507, 17.535, 20.090, 21.955},
            {1.735, 2.700, 3.325, 4.168, 14.684, 16.919, 19.023, 21.666, 23.589},
            {2.156, 3.247, 3.940, 4.865, 15.987, 18.307, 20.483, 23.209, 25.188},
            {2.603, 3.816, 4.575, 5.578, 17.275, 19.675, 21.920, 24.725, 26.757},
            {3.074, 4.404, 5.226, 6.304, 18.549, 21.026, 23.337, 26.217, 28.299},
            {3.565, 5.009, 5.892, 7.042, 19.812, 22.362, 24.736, 27.688, 29.819},
            {4.075, 5.629, 6.571, 7.790, 21.064, 23.685, 26.119, 29.141, 31.319},
            {4.601, 6.262, 7.261, 8.547, 22.307, 25.000, 27.488, 30.578, 32.801},
            {5.142, 6.908, 7.962, 9.312, 23.542, 26.296, 28.845, 31.999, 34.267},
            {5.697, 7.564, 8.672, 10.110, 24.769, 27.587, 30.191, 33.409, 35.718},
            {6.265, 8.231, 9.390, 10.868, 25.989, 28.869, 31.526, 34.805, 37.156},
            {6.844, 8.907, 10.117, 11.651, 27.204, 30.144, 32.852, 36.191, 38.582},
            {7.434, 9.591, 10.851, 12.443, 28.412, 31.410, 34.170, 37.566, 40.000}
        };
        String[] confidenceLevels = {"0.995", "0.975", "0.95", "0.90", "0.10", "0.05", "0.025", "0.01", "0.005"};

        // Création des séries principales X = χ², Y = df
        XYSeriesCollection dataset = new XYSeriesCollection();
        for (int col = 0; col < chiValues[0].length; col++) {
            XYSeries series = new XYSeries(confidenceLevels[col]);
            for (int row = 0; row < chiValues.length; row++) {
                series.add(chiValues[row][col], row + 1);
            }
            dataset.addSeries(series);
        }

        // Création du graphique
        JFreeChart chart = ChartFactory.createXYLineChart(
                "Chi-Square Critical Values",
                "Chi-Square",
                "Degrees of Freedom (df)",
                dataset,
                PlotOrientation.VERTICAL,
                true,
                true,
                false
        );
        chart.setAntiAlias(true);
        chart.getRenderingHints().put(RenderingHints.KEY_TEXT_ANTIALIASING, RenderingHints.VALUE_TEXT_ANTIALIAS_ON);

        XYPlot plot = chart.getXYPlot();
        plot.setBackgroundPaint(Color.WHITE);
        plot.setDomainGridlinePaint(Color.LIGHT_GRAY);
        plot.setRangeGridlinePaint(Color.LIGHT_GRAY);

        NumberAxis xAxis = (NumberAxis) plot.getDomainAxis();
        NumberAxis yAxis = (NumberAxis) plot.getRangeAxis();
        Font axisFont = new Font("SansSerif", Font.BOLD, 14);
        xAxis.setLabelFont(axisFont);
        yAxis.setLabelFont(axisFont);
        xAxis.setTickLabelFont(axisFont);
        yAxis.setTickLabelFont(axisFont);

        XYLineAndShapeRenderer renderer = new XYLineAndShapeRenderer(true, false);
        for (int i = 0; i < dataset.getSeriesCount(); i++) {
            renderer.setSeriesStroke(i, new BasicStroke(2.0f));
        }
        plot.setRenderer(renderer);

        // Ajouter le point du détecteur
        try {
            double chi2Value = Double.parseDouble(Main.textField_6.getText().trim().replace(",", "."));
            double dfValue   = Double.parseDouble(Main.textField_7.getText().trim().replace(",", "."));

            XYSeries detectorPoint = new XYSeries("Studied detector");
            detectorPoint.add(chi2Value, dfValue);
            XYSeriesCollection detectorDataset = new XYSeriesCollection();
            detectorDataset.addSeries(detectorPoint);

            XYLineAndShapeRenderer pointRenderer = new XYLineAndShapeRenderer(false, true);
            pointRenderer.setSeriesPaint(0, Color.MAGENTA);
            pointRenderer.setSeriesShape(0, new java.awt.geom.Ellipse2D.Double(-5, -5, 10, 10));
            pointRenderer.setSeriesStroke(0, new BasicStroke(3.0f));

            plot.setDataset(1, detectorDataset);
            plot.setRenderer(1, pointRenderer);

            XYTextAnnotation annotation = new XYTextAnnotation("Studied detector", chi2Value, dfValue + 0.5);
            annotation.setFont(new Font("SansSerif", Font.BOLD, 12));
            annotation.setPaint(Color.MAGENTA);
            plot.addAnnotation(annotation);

        } catch (Exception ignored) {}

        ChartPanel panel = new ChartPanel(chart);
        panel.setMouseWheelEnabled(true);
        panel.setDomainZoomable(true);
        panel.setRangeZoomable(true);

        setContentPane(panel);
        setVisible(true);
    }

    // Méthode statique pour calculer la probabilité la plus proche
    public static String getNearestProbability(double chi2Value, double dfValue) {
        double[][] chiValues = {
            {0.000, 0.000, 0.004, 0.016, 2.706, 3.841, 5.024, 6.635, 7.879},
            {0.010, 0.051, 0.103, 0.211, 4.605, 5.991, 7.378, 9.210, 10.597},
            {0.072, 0.216, 0.352, 0.584, 6.251, 7.815, 9.348, 11.345, 12.838},
            {0.207, 0.484, 0.711, 1.064, 7.779, 9.488, 11.143, 13.277, 14.860},
            {0.412, 0.831, 1.145, 1.610, 9.236, 11.070, 12.833, 15.086, 16.750},
            {0.676, 1.237, 1.635, 2.204, 10.645, 12.592, 14.449, 16.812, 18.548},
            {0.989, 1.690, 2.167, 2.833, 12.017, 14.067, 16.013, 18.475, 20.278},
            {1.344, 2.180, 2.733, 3.490, 13.362, 15.507, 17.535, 20.090, 21.955},
            {1.735, 2.700, 3.325, 4.168, 14.684, 16.919, 19.023, 21.666, 23.589},
            {2.156, 3.247, 3.940, 4.865, 15.987, 18.307, 20.483, 23.209, 25.188},
            {2.603, 3.816, 4.575, 5.578, 17.275, 19.675, 21.920, 24.725, 26.757},
            {3.074, 4.404, 5.226, 6.304, 18.549, 21.026, 23.337, 26.217, 28.299},
            {3.565, 5.009, 5.892, 7.042, 19.812, 22.362, 24.736, 27.688, 29.819},
            {4.075, 5.629, 6.571, 7.790, 21.064, 23.685, 26.119, 29.141, 31.319},
            {4.601, 6.262, 7.261, 8.547, 22.307, 25.000, 27.488, 30.578, 32.801},
            {5.142, 6.908, 7.962, 9.312, 23.542, 26.296, 28.845, 31.999, 34.267},
            {5.697, 7.564, 8.672, 10.110, 24.769, 27.587, 30.191, 33.409, 35.718},
            {6.265, 8.231, 9.390, 10.868, 25.989, 28.869, 31.526, 34.805, 37.156},
            {6.844, 8.907, 10.117, 11.651, 27.204, 30.144, 32.852, 36.191, 38.582},
            {7.434, 9.591, 10.851, 12.443, 28.412, 31.410, 34.170, 37.566, 40.000}
        };
        String[] confidenceLevels = {"0.995", "0.975", "0.95", "0.90", "0.10", "0.05", "0.025", "0.01", "0.005"};

        int dfIndex = (int)Math.round(dfValue) - 1;
        if (dfIndex < 0) dfIndex = 0;
        if (dfIndex >= chiValues.length) dfIndex = chiValues.length - 1;

        double minDiff = Double.MAX_VALUE;
        String nearestProb = "";

        for (int col = 0; col < chiValues[0].length; col++) {
            double diff = Math.abs(chi2Value - chiValues[dfIndex][col]);
            if (diff < minDiff) {
                minDiff = diff;
                nearestProb = confidenceLevels[col];
            }
        }
        return nearestProb;
    }
}
