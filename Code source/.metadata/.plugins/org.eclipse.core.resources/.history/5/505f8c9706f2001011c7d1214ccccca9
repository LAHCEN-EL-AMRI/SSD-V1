import javax.swing.JFrame;
import org.jfree.chart.ChartFactory;
import org.jfree.chart.ChartPanel;
import org.jfree.chart.JFreeChart;
import org.jfree.chart.plot.PlotOrientation;
import org.jfree.chart.plot.XYPlot;
import org.jfree.chart.renderer.xy.XYBarRenderer;
import org.jfree.chart.renderer.xy.XYLineAndShapeRenderer;
import org.jfree.data.xy.XYBarDataset;
import org.jfree.data.xy.XYSeries;
import org.jfree.data.xy.XYSeriesCollection;
import org.jfree.data.xy.IntervalXYDataset;

import javax.swing.table.DefaultTableModel;
import java.awt.Color;

public class Graph extends JFrame {

    private static final long serialVersionUID = 1L;

    public Graph(DefaultTableModel model) {

        setTitle("Statistical graphical visualization");
        setSize(900, 600);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);

        /* ============================
           Histogramme : F(Xi) = ni
           ============================ */
        XYSeries histSeries = new XYSeries("F(Xi) (observed)");

        /* ============================
           Courbe : N·L·P(Xi)
           ============================ */
        XYSeries curveSeries = new XYSeries("N·L·P(Xi) (theoretical)");

        for (int i = 0; i < model.getRowCount(); i++) {

            Object xiObj  = model.getValueAt(i, 1); // Xi
            Object niObj  = model.getValueAt(i, 2); // F(Xi)=ni
            Object nlpObj = model.getValueAt(i, 4); // N·L·P(Xi)

            if (xiObj == null || niObj == null || nlpObj == null) continue;
            if (xiObj.toString().isEmpty()) continue;

            try {
                double Xi  = Double.parseDouble(xiObj.toString());
                double ni  = Double.parseDouble(niObj.toString());
                double NlP = Double.parseDouble(nlpObj.toString());

                histSeries.add(Xi, ni);
                curveSeries.add(Xi, NlP);

            } catch (NumberFormatException ignored) {}
        }

        /* ============================
           Dataset histogramme
           ============================ */
        XYSeriesCollection histCollection = new XYSeriesCollection();
        histCollection.addSeries(histSeries);

        double barWidth = estimateBinWidth(model);
        IntervalXYDataset histDataset = new XYBarDataset(histCollection, barWidth);

        /* ============================
           Dataset courbe
           ============================ */
        XYSeriesCollection curveDataset = new XYSeriesCollection();
        curveDataset.addSeries(curveSeries);

        /* ============================
           Création du graphique
           ============================ */
        JFreeChart chart = ChartFactory.createXYBarChart(
                "Histogram and theoretical curve",
                "X",
                false,
                "Counts",
                histDataset,
                PlotOrientation.VERTICAL,
                true,
                true,
                false
        );

        XYPlot plot = chart.getXYPlot();

        /* ============================
           Renderer histogramme
           ============================ */
        XYBarRenderer barRenderer = (XYBarRenderer) plot.getRenderer();
        barRenderer.setSeriesPaint(0, new Color(0, 102, 204));
        barRenderer.setDrawBarOutline(true);

        /* ============================
           Ajout courbe théorique
           ============================ */
        plot.setDataset(1, curveDataset);

        XYLineAndShapeRenderer lineRenderer =
                new XYLineAndShapeRenderer(true, false);

        lineRenderer.setSeriesPaint(0, Color.RED);
        lineRenderer.setSeriesStroke(0, new java.awt.BasicStroke(2.5f));

        plot.setRenderer(1, lineRenderer);

        /* ============================
           Finalisation
           ============================ */
        ChartPanel chartPanel = new ChartPanel(chart);
        setContentPane(chartPanel);

        setVisible(true);
    }

    /* ============================
       Estimation largeur de classe
       ============================ */
    private double estimateBinWidth(DefaultTableModel model) {

        Double x1 = null, x2 = null;

        for (int i = 0; i < model.getRowCount(); i++) {
            Object xi = model.getValueAt(i, 1);
            if (xi != null && !xi.toString().isEmpty()) {
                if (x1 == null)
                    x1 = Double.parseDouble(xi.toString());
                else {
                    x2 = Double.parseDouble(xi.toString());
                    break;
                }
            }
        }

        if (x1 != null && x2 != null)
            return Math.abs(x2 - x1);

        return 1.0; // valeur par défaut
    }
}
