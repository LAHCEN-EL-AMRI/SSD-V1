import java.io.*;
import java.text.SimpleDateFormat;
import java.util.Date;

import javax.imageio.ImageIO;
import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import javax.swing.JTable;

import java.awt.Color;
import java.awt.Graphics2D;
import java.awt.RenderingHints;
import java.awt.image.BufferedImage;

import org.apache.pdfbox.pdmodel.*;
import org.apache.pdfbox.pdmodel.common.PDRectangle;
import org.apache.pdfbox.pdmodel.font.PDType0Font;
import org.apache.pdfbox.pdmodel.graphics.image.PDImageXObject;
import org.apache.pdfbox.pdmodel.PDPageContentStream;

public class Export {

    private Main main;
    private float y;
    private PDPageContentStream content;
    private PDType0Font font;
    private PDType0Font fontBold;

    private static final float MARGIN = 50;
    private static final float BOTTOM_MARGIN = 60;

    public Export(Main main) {
        this.main = main;
        exportPDF();
    }

    // =========================================================
    // MAIN
    // =========================================================
    private void exportPDF() {

        PDDocument document = null;

        try {
            document = new PDDocument();
            PDPage page = new PDPage(PDRectangle.A4);
            document.addPage(page);

            font = PDType0Font.load(document, new File("C:/Windows/Fonts/arial.ttf"));
            fontBold = font;

            content = new PDPageContentStream(document, page);
            y = PDRectangle.A4.getHeight() - MARGIN;

            drawHeader(document);
            writeCenteredTitle("Report on the Statistical Study of the Detector");

            writeSection("Additional informations");
            writeInfosFromFile();

            writeSection("Operating conditions");
            writeLineColored("Group width (l)", main.textField.getText());

            writeSection("Statistical values");
            writeLineColored("N", main.textField_1.getText());
            writeLineColored("Mean (X̄)", main.textField_2.getText());
            writeLineColored("σ_theoretical", main.textField_3.getText());
            writeLineColored("σ_experimental", main.textField_4.getText());

            writeEquationLine(
                    "P(X̄ - σ_exp < X(N+1) < X̄ + σ_exp) = ",
                    main.textField_5.getText()
            );

         // =====================================================
         // GRAPH — MÉTHODE PANEL (COMME TON EXEMPLE)
         // =====================================================
         try {
             // Créer le graphe, mais ne pas afficher la JFrame
             Graph graph = new Graph((DefaultTableModel) main.table.getModel(), false); 
             graph.setVisible(false); // JAMAIS affiché

             // Récupérer le panel contenant le chart
             JPanel chartPanel = graph.getChartPanel();

             // -----------------------------
             // FORCER LA TAILLE POUR CAPTURE
             // -----------------------------
             int imgWidth  = 1000; // largeur du graphe
             int imgHeight = 600;  // hauteur du graphe
             chartPanel.setSize(imgWidth, imgHeight);
             chartPanel.doLayout(); // recalculer le layout pour que tout soit affiché

             // Créer l'image
             BufferedImage graphImg = new BufferedImage(imgWidth, imgHeight, BufferedImage.TYPE_INT_ARGB);
             Graphics2D g2 = graphImg.createGraphics();
             g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
             g2.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING, RenderingHints.VALUE_TEXT_ANTIALIAS_ON);
             g2.setRenderingHint(RenderingHints.KEY_RENDERING, RenderingHints.VALUE_RENDER_QUALITY);

             // Fond blanc pour le PDF
             g2.setColor(Color.WHITE);
             g2.fillRect(0, 0, imgWidth, imgHeight);

             // Dessiner le graphe complet
             chartPanel.printAll(g2);
             g2.dispose();

             // -----------------------------
             // AJOUTER DANS LE PDF
             // -----------------------------
             if (y - 260 < BOTTOM_MARGIN) {
                 content.close();
                 page = new PDPage(PDRectangle.A4);
                 document.addPage(page);
                 content = new PDPageContentStream(document, page);
                 y = PDRectangle.A4.getHeight() - MARGIN;
             }

             PDImageXObject graphPDF = PDImageXObject.createFromByteArray(
                     document,
                     bufferedImageToPNG(graphImg),
                     "graph"
             );

             // Centrer le graphe dans le PDF avec proportions correctes
             float pdfWidth  = PDRectangle.A4.getWidth() - 2 * MARGIN;
             float pdfHeight = pdfWidth * imgHeight / imgWidth;
             float xImage = (PDRectangle.A4.getWidth() - pdfWidth) / 2;

             content.drawImage(
                     graphPDF,
                     xImage,
                     y - pdfHeight,
                     pdfWidth,
                     pdfHeight
             );

             y -= pdfHeight + 30;

             graph.dispose(); // libérer les ressources

         } catch (Exception ex) {
             ex.printStackTrace();
         }


            // =====================================================
            // PEARSON
            // =====================================================
            writeSection("Pearson chi-square test");
            writeLineColored("χ²", main.textField_6.getText());
            writeLineColored("Degrees of freedom (L)", main.textField_7.getText());
            writeLineColored("Probability P", main.textField_8.getText());

            writeSection("Measured data");
            writeTable(main.table);

            content.close();
            savePDF(document);

        } catch (Exception e) {
            e.printStackTrace();
            JOptionPane.showMessageDialog(null, "PDF error:\n" + e.getMessage());
        } finally {
            try { if (document != null) document.close(); }
            catch (IOException ignored) {}
        }
    }

    // =========================================================
    // PANEL CAPTURE (CLÉ DE LA SOLUTION)
    // =========================================================
    private BufferedImage capturePanel(JPanel panel) {

        int w = panel.getWidth();
        int h = panel.getHeight();

        if (w <= 0 || h <= 0) {
            w = 1050;
            h = 1000;
            panel.setSize(w, h);
            panel.doLayout();
        }

        BufferedImage img = new BufferedImage(
                w, h, BufferedImage.TYPE_INT_ARGB
        );

        Graphics2D g2 = img.createGraphics();
        g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING,
                RenderingHints.VALUE_ANTIALIAS_ON);
        g2.setRenderingHint(RenderingHints.KEY_RENDERING,
                RenderingHints.VALUE_RENDER_QUALITY);

        panel.printAll(g2);
        g2.dispose();

        return img;
    }

    // =========================================================
    // HEADER
    // =========================================================
    private void drawHeader(PDDocument document) throws IOException {

        try {
            PDImageXObject logo =
                    PDImageXObject.createFromFile("icons/image.PNG", document);
            content.drawImage(logo, 450, 750, 100, 50);
        } catch (Exception ignored) {}

        writeLineAt("SSD", 50, 770, fontBold, 14);
        writeLineAt("Version : 1.0", 50, 755, font, 9);
        writeLineAt("Link : https://github.com/LAHCEN-EL-AMRI", 50, 740, font, 9);
        writeLineAt("G_mail : lahssenelamri@gmail.com", 50, 725, font, 9);

        SimpleDateFormat d = new SimpleDateFormat("dd/MM/yy");
        SimpleDateFormat t = new SimpleDateFormat("HH:mm:ss");

        writeLineAtColor("Printed on: " + d.format(new Date()), 420, 755, font, 9, Color.RED);
        writeLineAtColor("Time: " + t.format(new Date()), 420, 740, font, 9, Color.RED);

        content.setStrokingColor(Color.BLACK);
        content.moveTo(50, 710);
        content.lineTo(550, 710);
        content.stroke();

        y = 690;
    }

    // =========================================================
    // TEXT UTILITIES
    // =========================================================
    private void writeCenteredTitle(String text) throws IOException {
        content.beginText();
        content.setFont(fontBold, 16);
        float w = fontBold.getStringWidth(text) / 1000 * 16;
        content.newLineAtOffset((PDRectangle.A4.getWidth() - w) / 2, y);
        content.showText(text);
        content.endText();
        y -= 25;
    }

    private void writeSection(String text) throws IOException {
        y -= 10;
        content.beginText();
        content.setFont(fontBold, 14);
        content.newLineAtOffset(MARGIN, y);
        content.showText(text);
        content.endText();
        y -= 15;
    }

    private void writeLineColored(String key, String value) throws IOException {
        content.beginText();
        content.setFont(font, 10);
        content.newLineAtOffset(MARGIN + 10, y);
        content.showText(key + ": ");
        content.endText();

        float w = font.getStringWidth(key + ": ") / 1000 * 10;

        content.beginText();
        content.setFont(font, 10);
        content.setNonStrokingColor(Color.BLUE);
        content.newLineAtOffset(MARGIN + 10 + w, y);
        content.showText(value);
        content.endText();

        content.setNonStrokingColor(Color.BLACK);
        y -= 14;
    }

    private void writeEquationLine(String eq, String value) throws IOException {
        writeLineColored(eq, value);
    }

    private void writeLineAt(String text, float x, float y,
                             PDType0Font f, int size) throws IOException {
        content.beginText();
        content.setFont(f, size);
        content.newLineAtOffset(x, y);
        content.showText(text);
        content.endText();
    }

    private void writeLineAtColor(String text, float x, float y,
                                  PDType0Font f, int size, Color c)
            throws IOException {
        content.setNonStrokingColor(c);
        writeLineAt(text, x, y, f, size);
        content.setNonStrokingColor(Color.BLACK);
    }

    // =========================================================
    // DATA
    // =========================================================
    private void writeInfosFromFile() throws IOException {

        File f = new File("Data/dat.dat");
        if (!f.exists()) {
            writeLineColored("Info", "No data file found");
            return;
        }

        BufferedReader br = new BufferedReader(new FileReader(f));
        String line;
        int i = 0;

        String[] labels = {
                "User Name", "Laboratory", "Detector Type", "Source",
                "Activity", "Production Date", "Applied Voltage",
                "Counting Time", "Repetitions", "Dead Time",
                "Saturation", "Other informations"
        };

        while ((line = br.readLine()) != null && i < labels.length) {
            writeLineColored(labels[i++], line);
        }
        br.close();
    }

    private void writeTable(JTable table) throws IOException {
        for (int r = 0; r < table.getRowCount(); r++) {
            StringBuilder sb = new StringBuilder();
            for (int c = 0; c < table.getColumnCount(); c++) {
                Object v = table.getValueAt(r, c);
                sb.append(v == null ? "" : v.toString()).append("   ");
            }
            writeLineColored("", sb.toString());
        }
    }

    private void savePDF(PDDocument document) throws IOException {

        File dir = new File("pdf_Export");
        if (!dir.exists()) dir.mkdirs();

        String name = "report_" +
                new SimpleDateFormat("yyyyMMdd_HHmmss").format(new Date()) + ".pdf";

        JFileChooser chooser = new JFileChooser(dir);
        chooser.setSelectedFile(new File(dir, name));

        if (chooser.showSaveDialog(null) == JFileChooser.APPROVE_OPTION) {
            document.save(chooser.getSelectedFile());
            JOptionPane.showMessageDialog(null,
                    "PDF saved:\n" + chooser.getSelectedFile().getAbsolutePath());
        }
    }

    private byte[] bufferedImageToPNG(BufferedImage img) throws IOException {
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        ImageIO.write(img, "png", baos);
        return baos.toByteArray();
    }
}
